{% extends "base.html" %}
{% block content %}
<h1>Sell an item</h1>
<form method="post" enctype="multipart/form-data" class="row g-3">
  <div class="col-12">
    <label class="form-label">Title</label>
    <input name="title" class="form-control" required>
  </div>
  <div class="col-12 d-flex align-items-start gap-2">
    <div style="flex:1">
      <label class="form-label">Description</label>
      <textarea name="description" class="form-control" rows="3"></textarea>
    </div>
    <div style="margin-left: .5rem; align-self:flex-end">
      <button id="genDescBtn" type="button" class="btn btn-secondary">Generate description</button>
      <div id="genSpinner" style="display:none;margin-top:.5rem">Generatingâ€¦</div>
    </div>
  </div>
  <div class="col-md-6">
    <label class="form-label">Price (USD)</label>
    <input name="price" class="form-control" type="number" step="0.01" required>
  </div>
  <div class="col-md-6">
    <label class="form-label">Quantity</label>
    <input name="quantity" class="form-control" type="number" min="1" value="1" required>
  </div>
  <div class="col-12">
    <label class="form-label">Item Image</label>
    <input name="image" type="file" class="form-control" accept="image/png,image/jpeg,image/gif">
    <small class="text-muted">PNG, JPG, JPEG, or GIF (max 5MB)</small>
  </div>
  <div class="col-12">
    <button class="btn btn-success">List Item</button>
  </div>
</form>

<script>
document.getElementById('genDescBtn').addEventListener('click', async () => {
  const title = document.querySelector('input[name="title"]').value || '';
  const price = document.querySelector('input[name="price"]').value || '';
  if (!title) {
    alert('Please enter a title first.');
    return;
  }
  const btn = document.getElementById('genDescBtn');
  const spinner = document.getElementById('genSpinner');
  btn.disabled = true;
  spinner.style.display = 'block';
  try {
    const res = await fetch('{{ url_for("generate_description_endpoint") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ title, price })
    });
    const j = await res.json();
    if (res.ok && j.description) {
      document.querySelector('textarea[name="description"]').value = j.description;
    } else {
      alert(j.error || j.message || 'Failed to generate description.');
    }
  } catch (err) {
    alert('Network error: ' + err);
  } finally {
    btn.disabled = false;
    spinner.style.display = 'none';
  }
});
</script>
{% endblock %}
